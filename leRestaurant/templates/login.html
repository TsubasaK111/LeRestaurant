{% extends "main.html" %}

{% block header %}
  <!--creates anonymous function to insert script into DOM into this page  -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js">
  </script>
  <script src="https://apis.google.com/js/client:platform.js?onload=start" async defer>
  </script>
{% endblock %}

{% block content %}

  <div class="row top-menu">
    <div class="col-md-6">
      <a href="{{url_for('showRestaurants')}}">
        <span class="glyphicon glyphicon-home" aria-hidden="true"></span>Show All Restaurants
      </a>
    </div>
  </div>
  <div class="row divider blue">
    <div class="col-md-12"></div>
  </div>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul>
        {% for message in messages %}
          <li><strong>{{ message }} </strong></li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <!--  Start Google OAuth -->

  <div id="sessionDebug">
    The current session state is {{ state }}
  <div id="signinButton">
    <span class="g-signin"
      data-scope="openid"
      data-clientid="26472003279-pkmnfsbkfpi3pu5d4bogmsruneu899ia.apps.googleusercontent.com"
      data-redirecturi="postmessage"
      data-accesstype="offline"
      data-cookiepolicy="single_host_origin"
      data-callback="signInCallback"
      data-approvalprompt="force">
    </span>
  </div>

  <script>
    function signInCallback(authorizationResult){
      // If server responds, do the following:
      if (authorizationResult['code']) {
        console.log("authorization! yays!")
        console.log(authorizationResult)

        // Hide the sign-in button, as the user is now authorized.
        $("#signinButton").attr("style","display: none");

        // Send "one-time-use code" via POST to server.
        $.ajax({
          type: "POST",
          url: "/google_connect?state={{ state }}",
          processData: false,
          contentType: "application/octet-stream; charset=utf-8",
          data: authorizationResult["code"],
          success: function(result) {
            // If POST is accepted (we get a 200/OK/success),
            // display server's response and redirect to /restaurants page
            //  after 4 secs.
            if (result) {
              console.log(result)
              $("#result").html(
                "SUCCESS, DUDES!! Result is:</br>"+result+"</br>Redirecting..."
              )
              setTimeout(function(){
                window.location.href="/restaurants";
              }, 4000);
            } else if (authorizationResult['error']) {
              // If google responds with an error, display it.
              console.log("There was an error: "+authorizationResult['error']);
            } else {
              // If we don't get a response (sadface!!!):
              $("#result").html("Failed to make server-side call. Check config and console (sadface) ");
            }
          }
        });
      }
    }
  </script>
  <!--  End Google OAuth -->


  <!--  Start Facebook OAuth -->

  <script>
    window.fbAsyncInit = function() {
      FB.init({
        appId      : '523665454488045',
        cookie     : true, //  enable cookies to allow server to access session
        xfbml      : true, //  parse social plugins on this page
        version    : 'v2.5' // the latest version as of 2016/02/06
      });
    };

    (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "//connect.facebook.net/en_US/sdk.js";
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));
  </script>

  <div
    class="fb-like"
    data-share="true"
    data-width="450"
    data-show-faces="true">
  </div>


  <div>
    <fb:login-button scope="public_profile,email" onlogin="sendTokenToServer();">
      <a href="javascript:sendTokenToServer()">Login with Facebook</a>
    </fb:login-button>
  </div>

  <div id="result"></div>

{% endblock %}
